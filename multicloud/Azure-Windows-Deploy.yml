# Description
# ===========
# This playbook create an Azure VM with public IP, and open 22 port for SSH
# This playbook creates an EC2 VM with public IP, and assign to security group with port 22 open.

---
- name : Deploy Windows on Azure
  hosts: localhost 
  gather_facts: False
  vars: 
    resource_group: mswin
    vm_name: MSW2016
    resource_group: ansibletower
    location: australiacentral
  tasks:
    - block:
      - name: set fact for Extension Code
        set_fact:
          winrm_enable_script: SQBuAHYAbwBrAGUALQBFAHgAcAByAGUAcwBzAGkAbwBuACAALQBDAG8AbQBtAGEAbgBkACAAKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAE4AZQB0AC4AVwBlAGIAQwBsAGkAZQBuAHQAKQAuAEQAbwB3AG4AbABvAGEAZABTAHQAcgBpAG4AZwAoACcAaAB0AHQAcABzADoALwAvAHIAYQB3AC4AZwBpAHQAaAB1AGIAdQBzAGUAcgBjAG8AbgB0AGUAbgB0AC4AYwBvAG0ALwBhAG4AcwBpAGIAbABlAC8AYQBuAHMAaQBiAGwAZQAvAGQAZQB2AGUAbAAvAGUAeABhAG0AcABsAGUAcwAvAHMAYwByAGkAcAB0AHMALwBDAG8AbgBmAGkAZwB1AHIAZQBSAGUAbQBvAHQAaQBuAGcARgBvAHIAQQBuAHMAaQBiAGwAZQAuAHAAcwAxACcAKQApADsAIABFAG4AYQBiAGwAZQAtAFcAUwBNAGEAbgBDAHIAZQBkAFMAUwBQACAALQBSAG8AbABlACAAUwBlAHIAdgBlAHIAIAAtAEYAbwByAGMAZQA=

      - name: Azure Create virtual network
        azure_rm_virtualnetwork:
          resource_group: "{{ resource_group }}"
          name: "{{ vm_name }}"
          address_prefixes: "20.0.0.0/16"
      - name: Azure Add subnet
        azure_rm_subnet:
          resource_group: "{{ resource_group }}"
          name: "{{ vm_name }}"
          address_prefix: "20.0.1.0/24"
          virtual_network: "{{ vm_name }}"

      - name: Azure Create Network Security Group that allows SSH and Windows Ports
        azure_rm_securitygroup:
          resource_group: "{{ resource_group }}"
          name: "{{ vm_name }}"
          rules:
            - name: SSH
              protocol: Tcp
              destination_port_range: 22
              access: Allow
              priority: 1001
              direction: Inbound
            - name: HTTP
              protocol: Tcp
              destination_port_range: 80
              access: Allow
              priority: 1002
              direction: Inbound
            - name: HTTPS
              protocol: Tcp
              destination_port_range: 443
              access: Allow
              priority: 1003
              direction: Inbound
            - name: LB
              protocol: Tcp
              destination_port_range: 8888
              access: Allow
              priority: 1004
              direction: Inbound
            - name: RDP
              protocol: Tcp
              destination_port_range: 3389
              access: Allow
              priority: 500
              direction: Inbound
            - name: WINRM
              protocol: Tcp
              destination_port_range: 5985
              access: Allow
              priority: 501
              direction: Inbound
            - name: WINRMs
              protocol: Tcp
              destination_port_range: 5986
              access: Allow
              priority: 502
              direction: Inbound
              
      # Create windows
      - name: Create windows public IP address
        azure_rm_publicipaddress:
          resource_group: "{{ resource_group }}"
          allocation_method: Static
          name: mswin

      - name: Create windows virtual network inteface card
        azure_rm_networkinterface:
          resource_group: "{{ resource_group }}"
          name: mswin
          virtual_network: "{{ vm_name }}"
          subnet: "{{ vm_name }}"
          public_ip_name: mswin
          security_group: "{{ vm_name }}"

      - name: Azure Create windows VM
        azure_rm_virtualmachine:
          resource_group: "{{ resource_group }}"
          name: mswin
          vm_size: Standard_DS1_v2
          os_type: Windows
          admin_username: ec2-user 
          admin_password: Password@123
          network_interfaces: mswin
          tags:
            tag_ansible_group : mswin
          image:
            publisher: MicrosoftWindowsServer
            offer: WindowsServer
            sku: 2016-Datacenter
            version: latest
        register: output	
      
      - name: create Azure vm extension to enable HTTPS WinRM listener
        azure_rm_virtualmachine_extension:
          name: winrm-extension
          resource_group: "{{ resource_group }}"
          virtual_machine_name: mswin
          publisher: Microsoft.Compute
          virtual_machine_extension_type: CustomScriptExtension
          type_handler_version: 1.9
          settings: '{"commandToExecute": "powershell.exe -ExecutionPolicy ByPass -EncodedCommand {{winrm_enable_script}}"}'
          auto_upgrade_minor_version: true
